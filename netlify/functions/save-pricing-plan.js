// netlify/functions/save-pricing-plan.js
const { getDbClient } = require('./db-config');

exports.handler = async function(event, context) {
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "Method Not Allowed" })
    };
  }

  let client;
  try {
    const data = JSON.parse(event.body);
    const { id, name, price, rawPrice, interval, planCode, features } = data;

    // Basic validation
    if (!name || !price || typeof rawPrice === 'undefined' || !interval || !planCode || !Array.isArray(features)) {
      return {
        statusCode: 400,
        headers: { "Access-Control-Allow-Origin": "*" },
        body: JSON.stringify({ error: "Missing required plan fields or features is not an array." })
      };
    }

    client = await getDbClient();

    let result;
    if (id) {
      // Update existing plan
      result = await client.query(
        `UPDATE pricing_plans SET
           name = $1, price = $2, raw_price = $3, interval = $4, plan_code = $5, features = $6, updated_at = CURRENT_TIMESTAMP
         WHERE id = $7 RETURNING *`,
        [name, price, rawPrice, interval, planCode, features, id]
      );
    } else {
      // Add new plan (id is UUID, generated by default)
      result = await client.query(
        `INSERT INTO pricing_plans (name, price, raw_price, interval, plan_code, features)
         VALUES ($1, $2, $3, $4, $5, $6) RETURNING *`,
        [name, price, rawPrice, interval, planCode, features]
      );
    }

    if (result.rowCount === 0 && id) { // If updating, and no row was affected
        return {
            statusCode: 404,
            headers: { "Access-Control-Allow-Origin": "*" },
            body: JSON.stringify({ error: "Pricing plan not found for update." })
        };
    }

    return {
      statusCode: id ? 200 : 201, // 200 OK for update, 201 Created for new
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization"
      },
      body: JSON.stringify(result.rows[0])
    };
  } catch (error) {
    console.error('Error saving pricing plan:', error);
    return {
      statusCode: 500,
      headers: {
        "Access-Control-Allow-Origin": "*",
      },
      body: JSON.stringify({ error: 'Failed to save pricing plan', details: error.message })
    };
  } finally {
    if (client) {
      client.release();
    }
  }
};